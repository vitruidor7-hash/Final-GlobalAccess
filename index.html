<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Budget Spreadsheet</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>üìä Monthly Budget Spreadsheet</h1>
        
        <div class="header-controls">
            <div class="month-selector">
                <label for="month">Month: </label>
                <input type="month" id="month">
                <span class="save-indicator" id="saveIndicator" style="display: none;">‚úì Auto-saved</span>
            </div>
            <div class="import-controls">
                <select id="importMonth">
                    <option value="">Select month to import from</option>
                </select>
                <button class="import-btn" onclick="importIncome()">Import Income</button>
                <button class="import-btn" onclick="importBills()">Import Bills</button>
                <button class="import-btn" onclick="importFixedExpenses()">Import Fixed</button>
                <button class="import-btn" onclick="importSemiFixedExpenses()">Import Semi-Fixed</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'Plan')">üóìÔ∏è Plan</button>
            <button class="tab-link" onclick="openTab(event, 'Expenses')">üí∏ Expenses</button>
            <button class="tab-link" onclick="openTab(event, 'Extract')">üìä Budget Extract</button>
        </div>

        <div id="Plan" class="tab-content" style="display: block;">
            <div class="section">
                <h2 class="section-title">üí∞ Planned Income</h2>
                <table>
                    <thead>
                        <tr><th>Source</th><th style="width: 150px;">Amount</th><th style="width: 120px;">Received <input type="checkbox" onchange="toggleAll(this, 'plannedIncomeBody')"></th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="plannedIncomeBody"></tbody>
                    <tfoot>
                        <tr><td colspan="4"><button onclick="addPlannedIncomeRow()">+ Add Planned Income</button></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title">üßæ Incoming Bills</h2>
                <table>
                    <thead>
                        <tr><th>Bill</th><th style="width: 130px;">Amount</th><th style="width: 150px;">Due Date</th><th style="width: 180px;">Category</th><th style="width: 100px;">Paid <input type="checkbox" onchange="toggleAll(this, 'plannedBillsBody')"></th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="plannedBillsBody"></tbody>
                    <tfoot>
                        <tr><td colspan="6"><button onclick="addPlannedBillRow()">+ Add Bill</button></td></tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="Expenses" class="tab-content">
             <div class="section">
                <h2 class="section-title">üí∞ Received Income</h2>
                <table id="incomeTable">
                    <thead>
                        <tr><th>Source</th><th style="width: 150px;">Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="incomeBody"></tbody>
                    <tfoot>
                        <tr class="total-row"><td>TOTAL RECEIVED</td><td id="totalIncome">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title">üîí Fixed Expenses</h2>
                <table>
                    <thead>
                        <tr><th>Expense</th><th style="width: 150px;">Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="fixedBody"></tbody>
                    <tfoot>
                         <tr><td colspan="3"><button onclick="addRow('fixedBody', 'fixed-amount')">+ Add Fixed Expense</button></td></tr>
                        <tr class="total-row"><td>TOTAL FIXED</td><td id="totalFixed">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title">üìä Semi-Fixed Expenses</h2>
                <table>
                    <thead>
                        <tr><th>Expense</th><th style="width: 150px;">Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="semiFixedBody"></tbody>
                    <tfoot>
                        <tr><td colspan="3"><button onclick="addRow('semiFixedBody', 'semifixed-amount')">+ Add Semi-Fixed Expense</button></td></tr>
                        <tr class="total-row"><td>TOTAL SEMI-FIXED</td><td id="totalSemiFixed">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title">‚ûï Extra Expenses</h2>
                <table>
                    <thead>
                        <tr><th>Expense</th><th style="width: 150px;">Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="extraBody"></tbody>
                    <tfoot>
                        <tr><td colspan="3"><button onclick="addRow('extraBody', 'extra-amount')">+ Add Extra Expense</button></td></tr>
                        <tr class="total-row"><td>TOTAL EXTRA</td><td id="totalExtra">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>
             <div class="section">
                <h2 class="section-title">üìÖ Long-Lasting Expenses (Loans)</h2>
                <table>
                    <thead>
                        <tr><th>Loan Name</th><th style="width: 130px;">Amount Left</th><th style="width: 130px;">Monthly Payment</th><th style="width: 110px;">Months Left</th><th style="width: 150px;">Increase Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="loansBody"></tbody>
                    <tfoot>
                        <tr><td colspan="6"><button onclick="addLoanRow()">+ Add Loan</button></td></tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div id="Extract" class="tab-content">
            <div class="extract-section">
                <h2 class="section-title">üìà Budget Extract</h2>
                <div class="extract-grid" id="extractGrid"></div>
            </div>
    
            <div class="section">
                <h2 class="section-title">üí≥ Total Expenses</h2>
                <table>
                    <tbody>
                        <tr class="total-row"><td>TOTAL EXPENSES</td><td id="totalExpenses">$0.00</td><td></td></tr>
                    </tbody>
                </table>
            </div>
    
            <div class="balance-section">
                <h2>Final Balance</h2>
                <div class="balance-amount" id="finalBalance">$0.00</div>
            </div>
        </div>

    </div>
    
    <script type="module">
    // --- Firebase Configuration Injection ---
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBBldcELdbWroTVAoy5L1kw0_urUFfxMSc",
        authDomain: "finances-c7df4.firebaseapp.com",
        projectId: "finances-c7df4",
        storageBucket: "finances-c7df4.firebasestorage.app",
        messagingSenderId: "47587476297",
        appId: "1:47587476297:web:1077b1533e072b13801098",
        measurementId: "G-FEKN3WMBFS"
    };
    const APP_ID = FIREBASE_CONFIG.appId;
    const __firebase_config = JSON.stringify(FIREBASE_CONFIG);
    const __app_id = APP_ID;
    const SHARED_DOCUMENT_ID = "Budget_Global_Shared_Master"; 

    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global State and Firebase Variables ---
    let budgets = {};
    let currentMonth = '';
    let saveTimeout = null;
    let db;
    let userId;
    let isAuthReady = false;

    // --- Firebase Initialization ---
    async function initializeFirebase() {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        if (!firebaseConfig.apiKey) {
            document.body.innerHTML = '<h1>Error: Firebase configuration is missing.</h1>';
            return;
        }
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        userId = SHARED_DOCUMENT_ID;
        isAuthReady = true;
        await initApp();
    }

    // --- Application Initialization ---
    async function initApp() {
        if (!isAuthReady) return; 
        const now = new Date();
        currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('month').value = currentMonth;
        await loadBudgetsFromFirestore();
        loadCurrentMonthUI();
        attachListeners();
    }

    // --- Firebase Persistence ---
    async function loadBudgetsFromFirestore() {
        if (!userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/budgets/allData`);
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                budgets = docSnap.data() || {};
                console.log("Budgets loaded from Firestore.");
            } else {
                console.log("No existing budget document. Starting fresh.");
                budgets = {};
            }
        } catch (error) {
            console.error("Error loading budgets from Firestore:", error);
            budgets = {}; 
        }
        updateImportMonthOptions();
    }

    async function saveBudgetsToFirestore() {
        if (!userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/budgets/allData`);
        try {
            await setDoc(docRef, { ...budgets }); // Use spread to ensure it's a new object
            console.log("Budgets saved to Firestore.");
        } catch (error) {
            console.error("Error saving budgets to Firestore:", error);
        }
    }

    // --- Auto-Save Functionality ---
    function autoSave() {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveCurrentMonth();
            showSaveIndicator();
        }, 1000);
    }

    function showSaveIndicator() {
        const indicator = document.getElementById('saveIndicator');
        indicator.style.display = 'inline-block';
        setTimeout(() => { indicator.style.display = 'none'; }, 2000);
    }

    // --- Core Data Handling ---
    function saveCurrentMonth() {
        const data = {
            plannedIncome: extractPlannedIncomeData(),
            plannedBills: extractPlannedBillsData(),
            income: extractTableData('incomeBody'),
            fixed: extractTableData('fixedBody'),
            semFixed: extractTableData('semiFixedBody'),
            extra: extractTableData('extraBody'),
            loans: extractLoanData()
        };
        
        const hasData = Object.values(data).some(arr => arr.length > 0 && arr.some(item => Object.values(item).some(val => val)));

        if (hasData) {
            budgets[currentMonth] = data;
        } else if (budgets[currentMonth]) {
            delete budgets[currentMonth];
        }
        saveBudgetsToFirestore();
        updateImportMonthOptions();
    }
    
    function extractPlannedIncomeData() {
        const rows = [];
        document.querySelectorAll('#plannedIncomeBody tr').forEach(row => {
            const descInput = row.querySelector('input[type="text"]');
            const amountInput = row.querySelector('input[type="number"]');
            const receivedCheckbox = row.querySelector('input[type="checkbox"]');
            rows.push({ 
                description: descInput.value, 
                amount: parseFloat(amountInput.value) || 0,
                received: receivedCheckbox.checked,
                id: row.dataset.id
            });
        });
        return rows;
    }
    
    function extractPlannedBillsData() {
        const rows = [];
        document.querySelectorAll('#plannedBillsBody tr').forEach(row => {
            const descInput = row.querySelector('input[type="text"]');
            const amountInput = row.querySelector('.bill-amount');
            const dateInput = row.querySelector('input[type="date"]');
            const categorySelect = row.querySelector('select');
            const paidCheckbox = row.querySelector('input[type="checkbox"]');
            rows.push({ 
                description: descInput.value, 
                amount: parseFloat(amountInput.value) || 0,
                dueDate: dateInput.value,
                category: categorySelect.value,
                paid: paidCheckbox.checked,
                id: row.dataset.id
            });
        });
        return rows;
    }

    function extractTableData(bodyId) {
        const rows = [];
        document.querySelectorAll(`#${bodyId} tr`).forEach(row => {
            const isManual = !row.dataset.sourceId; // Check if it's a manually added row
            if (isManual) {
                const descInput = row.querySelector('input[type="text"]');
                const amountInput = row.querySelector('input[type="number"]');
                rows.push({ 
                    description: descInput ? descInput.value : '', 
                    amount: parseFloat(amountInput ? amountInput.value : '0') || 0,
                });
            }
        });
        return rows;
    }

    function extractLoanData() {
        const loans = [];
        document.querySelectorAll('#loansBody tr').forEach(row => {
            const name = row.querySelector('input[type="text"]').value;
            const left = parseFloat(row.querySelector('.loan-left').value) || 0;
            const monthly = parseFloat(row.querySelector('.loan-monthly').value) || 0;
            loans.push({ name, amountLeft: left, monthlyPayment: monthly });
        });
        return loans;
    }

    // --- UI Population and Updates ---
    function loadCurrentMonthUI() {
        const data = budgets[currentMonth] || {};
        clearAllTables();
        
        loadPlannedIncome(data.plannedIncome || []);
        loadPlannedBills(data.plannedBills || []);
        
        // Load only manually-added items, as plan-based items are handled by rebuildActualsFromPlan
        loadTableData('incomeBody', 'income-amount', data.income || []);
        loadTableData('fixedBody', 'fixed-amount', data.fixed || []);
        loadTableData('semiFixedBody', 'semifixed-amount', data.semFixed || []);
        loadTableData('extraBody', 'extra-amount', data.extra || []);
        loadLoanData(data.loans || []);
        
        rebuildActualsFromPlan();
        
        calculate();
    }

    function clearAllTables() {
        ['plannedIncomeBody', 'plannedBillsBody', 'incomeBody', 'fixedBody', 'semiFixedBody', 'extraBody', 'loansBody'].forEach(clearTable);
    }
    
    function clearTable(bodyId) {
        document.getElementById(bodyId).innerHTML = '';
    }
    
    function loadPlannedIncome(plannedIncomes) {
        (plannedIncomes.length ? plannedIncomes : [{}]).forEach((item, index) => addPlannedIncomeRow(item, index));
    }

    function loadPlannedBills(plannedBills) {
        (plannedBills.length ? plannedBills : [{}]).forEach((item, index) => addPlannedBillRow(item, index));
    }
    
    function rebuildActualsFromPlan() {
        const plannedIncome = budgets[currentMonth]?.plannedIncome || [];
        plannedIncome.forEach(item => {
            if (item.received) {
                addActualRow('incomeBody', { description: item.description, amount: item.amount, sourceId: item.id });
            }
        });

        const plannedBills = budgets[currentMonth]?.plannedBills || [];
        plannedBills.forEach(item => {
            if (item.paid) {
                const targetTable = { 'fixed': 'fixedBody', 'semifixed': 'semiFixedBody', 'extra': 'extraBody' }[item.category];
                if (targetTable) {
                    addActualRow(targetTable, { description: item.description, amount: item.amount, sourceId: item.id });
                }
            }
        });
    }

    function loadTableData(bodyId, className, data) {
        (data && data.length > 0 ? data : []).forEach(item => {
            if (!item.sourceId) {
                 addRow(bodyId, className, item);
            }
        });
    }
    
    function loadLoanData(loans) {
        (loans && loans.length > 0 ? loans : [{}]).forEach(loan => addLoanRow(loan));
    }

    // --- Global Functions for UI Interaction ---
    window.openTab = function(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // NEW: Generic function to check/uncheck all items in a planning table
    window.toggleAll = function(sourceCheckbox, bodyId) {
        const tbody = document.getElementById(bodyId);
        const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
        
        checkboxes.forEach(checkbox => {
            if (checkbox.checked !== sourceCheckbox.checked) {
                checkbox.checked = sourceCheckbox.checked;
                // Simulate a change event to trigger the existing handler logic
                checkbox.dispatchEvent(new Event('change'));
            }
        });
    }

    window.addRow = function(bodyId, className, item = {}) {
        const tbody = document.getElementById(bodyId);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><input type="text" placeholder="Description" value="${item.description || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="${className}" value="${item.amount || ''}"></td>
            <td><button class="delete" onclick="deleteRow(this)">Delete</button></td>
        `;
        attachListenersToRow(row);
    }
    
    window.addPlannedIncomeRow = function(item = {}, index) {
        const tbody = document.getElementById('plannedIncomeBody');
        const row = tbody.insertRow();
        const id = item.id || `income-${Date.now()}-${index}`; // More robust ID
        row.dataset.id = id;
        row.innerHTML = `
            <td><input type="text" placeholder="Source" value="${item.description || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" value="${item.amount || ''}"></td>
            <td><input type="checkbox" onchange="handleIncomeReceived(this)" ${item.received ? 'checked' : ''}></td>
            <td><button class="delete" onclick="deletePlannedRow(this, 'income')">Delete</button></td>
        `;
        if (item.received) row.classList.add('paid');
        attachListenersToRow(row);
    }

    window.addPlannedBillRow = function(item = {}, index) {
        const tbody = document.getElementById('plannedBillsBody');
        const row = tbody.insertRow();
        const id = item.id || `bill-${Date.now()}-${index}`; // More robust ID
        row.dataset.id = id;
        row.innerHTML = `
            <td><input type="text" placeholder="Bill Name" value="${item.description || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="bill-amount" value="${item.amount || ''}"></td>
            <td><input type="date" value="${item.dueDate || ''}"></td>
            <td>
                <select>
                    <option value="fixed" ${item.category === 'fixed' ? 'selected' : ''}>Fixed</option>
                    <option value="semifixed" ${item.category === 'semifixed' ? 'selected' : ''}>Semi-Fixed</option>
                    <option value="extra" ${item.category === 'extra' ? 'selected' : ''}>Extra</option>
                </select>
            </td>
            <td><input type="checkbox" onchange="handlePayment(this)" ${item.paid ? 'checked' : ''}></td>
            <td><button class="delete" onclick="deletePlannedRow(this, 'bill')">Delete</button></td>
        `;
        if (item.paid) row.classList.add('paid');
        attachListenersToRow(row);
    }
    
    function addActualRow(bodyId, item) {
        // Prevent adding duplicates
        if (document.querySelector(`#${bodyId} tr[data-source-id="${item.sourceId}"]`)) return;
        const tbody = document.getElementById(bodyId);
        const row = tbody.insertRow();
        row.dataset.sourceId = item.sourceId; 
        row.innerHTML = `
            <td><input type="text" value="${item.description || ''}" readonly></td>
            <td><input type="number" step="0.01" value="${item.amount || ''}" readonly></td>
            <td></td>
        `;
    }

    window.addLoanRow = function(loan = {}) {
        const tbody = document.getElementById('loansBody');
        const row = tbody.insertRow();
        const monthsLeft = (loan.monthlyPayment > 0 && loan.amountLeft) ? Math.ceil(loan.amountLeft / loan.monthlyPayment) : 0;
        row.innerHTML = `
            <td><input type="text" placeholder="Loan Name" value="${loan.name || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="loan-left" value="${loan.amountLeft || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="loan-monthly" value="${loan.monthlyPayment || ''}"></td>
            <td><input type="number" placeholder="0" class="loan-months" readonly value="${monthsLeft}"></td>
            <td><div class="loan-increase-controls"><input type="number" step="0.01" placeholder="0.00" class="loan-increase-input"><button class="increase-btn" onclick="increaseLoan(this)">+</button></div></td>
            <td><button class="delete" onclick="deleteRow(this)">Delete</button></td>
        `;
        attachListenersToRow(row);
    }
    
    window.handleIncomeReceived = function(checkbox) {
        const row = checkbox.closest('tr');
        const id = row.dataset.id;
        if (checkbox.checked) {
            row.classList.add('paid');
            const desc = row.querySelector('input[type="text"]').value;
            const amount = row.querySelector('input[type="number"]').value;
            addActualRow('incomeBody', { description: desc, amount: amount, sourceId: id });
        } else {
            row.classList.remove('paid');
            const existingRow = document.querySelector(`#incomeBody tr[data-source-id="${id}"]`);
            if (existingRow) existingRow.remove();
        }
        calculate();
        autoSave();
    }

    window.handlePayment = function(checkbox) {
        const row = checkbox.closest('tr');
        const id = row.dataset.id;
        const category = row.querySelector('select').value;
        const targetTable = { 'fixed': 'fixedBody', 'semifixed': 'semiFixedBody', 'extra': 'extraBody' }[category];
        
        if (!targetTable) return;

        if (checkbox.checked) {
            row.classList.add('paid');
            const desc = row.querySelector('input[type="text"]').value;
            const amount = row.querySelector('.bill-amount').value;
            addActualRow(targetTable, { description: desc, amount: amount, sourceId: id });
        } else {
            row.classList.remove('paid');
            const existingRow = document.querySelector(`#${targetTable} tr[data-source-id="${id}"]`);
            if (existingRow) existingRow.remove();
        }
        calculate();
        autoSave();
    }
    
    window.deleteRow = function(btn) {
        btn.closest('tr').remove();
        calculate();
        autoSave();
    }
    
    window.deletePlannedRow = function(btn, type) {
        const row = btn.closest('tr');
        const id = row.dataset.id;
        let correspondingRow;

        if (type === 'bill') {
            correspondingRow = document.querySelector(`#fixedBody tr[data-source-id="${id}"], #semiFixedBody tr[data-source-id="${id}"], #extraBody tr[data-source-id="${id}"]`);
        } else if (type === 'income') {
            correspondingRow = document.querySelector(`#incomeBody tr[data-source-id="${id}"]`);
        }
        
        if (correspondingRow) correspondingRow.remove();
        row.remove();
        calculate();
        autoSave();
    }

    function calculate() {
        const totalIncome = Array.from(document.querySelectorAll('#incomeBody input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
        const totalFixed = Array.from(document.querySelectorAll('#fixedBody input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
        const totalSemiFixed = Array.from(document.querySelectorAll('#semiFixedBody input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
        const totalExtra = Array.from(document.querySelectorAll('#extraBody input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);

        document.getElementById('totalIncome').textContent = '$' + totalIncome.toFixed(2);
        document.getElementById('totalFixed').textContent = '$' + totalFixed.toFixed(2);
        document.getElementById('totalSemiFixed').textContent = '$' + totalSemiFixed.toFixed(2);
        document.getElementById('totalExtra').textContent = '$' + totalExtra.toFixed(2);

        document.querySelectorAll('#loansBody tr').forEach(row => {
            const amountLeft = parseFloat(row.querySelector('.loan-left').value) || 0;
            const monthlyPayment = parseFloat(row.querySelector('.loan-monthly').value) || 0;
            row.querySelector('.loan-months').value = monthlyPayment > 0 ? Math.ceil(amountLeft / monthlyPayment) : 0;
        });
        
        const totalExpenses = totalFixed + totalSemiFixed + totalExtra;
        const balance = totalIncome - totalExpenses;
        const balanceEl = document.getElementById('finalBalance');
        
        document.getElementById('totalExpenses').textContent = '$' + totalExpenses.toFixed(2);
        balanceEl.textContent = '$' + balance.toFixed(2);
        balanceEl.className = 'balance-amount';
        balanceEl.classList.add(balance >= 0 ? 'positive' : 'negative');

        updateExtract();
    }
    
    // --- Import/Export and Listeners ---
    function updateImportMonthOptions() {
        const select = document.getElementById('importMonth');
        select.innerHTML = '<option value="">Select month to import from</option>';
        Object.keys(budgets).sort().reverse().forEach(month => {
            if (month !== currentMonth) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                select.appendChild(option);
            }
        });
    }
    
    // REVISED: Import functions now update the state and reload the entire UI
    window.importIncome = function() {
        const selectedMonth = document.getElementById('importMonth').value;
        if (!selectedMonth || !budgets[selectedMonth]) return;

        if (!budgets[currentMonth]) budgets[currentMonth] = {};

        // Deep copy to prevent reference issues
        const importedData = JSON.parse(JSON.stringify(budgets[selectedMonth].plannedIncome || []));
        budgets[currentMonth].plannedIncome = importedData;
        
        loadCurrentMonthUI(); // Reload UI from the new state
        autoSave();
    }
    
    window.importBills = function() {
        const selectedMonth = document.getElementById('importMonth').value;
        if (!selectedMonth || !budgets[selectedMonth]) return;

        if (!budgets[currentMonth]) budgets[currentMonth] = {};
        
        const importedData = JSON.parse(JSON.stringify(budgets[selectedMonth].plannedBills || []));
        budgets[currentMonth].plannedBills = importedData;
        
        loadCurrentMonthUI();
        autoSave();
    }

    window.importFixedExpenses = function() {
        const selectedMonth = document.getElementById('importMonth').value;
        if (!selectedMonth || !budgets[selectedMonth]) return;

        if (!budgets[currentMonth]) budgets[currentMonth] = {};

        const importedData = JSON.parse(JSON.stringify(budgets[selectedMonth].fixed || []));
        budgets[currentMonth].fixed = importedData;

        loadCurrentMonthUI();
        autoSave();
    }

    window.importSemiFixedExpenses = function() {
        const selectedMonth = document.getElementById('importMonth').value;
        if (!selectedMonth || !budgets[selectedMonth]) return;

        if (!budgets[currentMonth]) budgets[currentMonth] = {};

        const importedData = JSON.parse(JSON.stringify(budgets[selectedMonth].semFixed || []));
        budgets[currentMonth].semFixed = importedData;

        loadCurrentMonthUI();
        autoSave();
    }
    
    window.increaseLoan = function(btn) {
        const row = btn.closest('tr');
        const increaseInput = row.querySelector('.loan-increase-input');
        const leftInput = row.querySelector('.loan-left');
        const increaseAmount = parseFloat(increaseInput.value) || 0;
        if (increaseAmount <= 0) return;
        leftInput.value = ((parseFloat(leftInput.value) || 0) + increaseAmount).toFixed(2);
        increaseInput.value = '';
        calculate();
        autoSave();
    }

    function updateExtract() {
        const grid = document.getElementById('extractGrid');
        grid.innerHTML = '';
        const balanceText = document.getElementById('finalBalance').textContent;
        addExtractItem(grid, 'Total Received Income', document.getElementById('totalIncome').textContent, '#2ecc71');
        addExtractItem(grid, 'Fixed Expenses', document.getElementById('totalFixed').textContent, '#e74c3c');
        addExtractItem(grid, 'Semi-Fixed Expenses', document.getElementById('totalSemiFixed').textContent, '#e67e22');
        addExtractItem(grid, 'Total Extra Expenses', document.getElementById('totalExtra').textContent, '#f39c12');
        addExtractItem(grid, 'Total Expenses', document.getElementById('totalExpenses').textContent, '#c0392b');
        addExtractItem(grid, 'Final Balance', balanceText, balanceText.includes('-') ? '#e74c3c' : '#27ae60');
    }

    function addExtractItem(grid, title, amount, color) {
        const item = document.createElement('div');
        item.className = 'extract-item';
        item.style.borderLeftColor = color;
        item.innerHTML = `<h4>${title}</h4><div class="amount">${amount}</div>`;
        grid.appendChild(item);
    }

    function attachListeners() {
        const container = document.querySelector('.container');
        container.addEventListener('input', (e) => {
            if (e.target.matches('input, select')) {
                calculate();
                autoSave();
            }
        });

        document.getElementById('month').addEventListener('change', (e) => {
            saveCurrentMonth();
            currentMonth = e.target.value;
            loadCurrentMonthUI();
        });
    }
    
    function attachListenersToRow(row) {
        row.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', () => {
                calculate();
                autoSave();
            });
        });
    }

    // --- App Start ---
    document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
