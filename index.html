<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Budget Spreadsheet</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>üìä Monthly Budget Spreadsheet</h1>
        
        <div class="header-controls">
            <div class="month-selector">
                <label for="month">Month: </label>
                <input type="month" id="month">
                <span class="save-indicator" id="saveIndicator" style="display: none;">‚úì Auto-saved</span>
            </div>
            <div class="import-controls">
                <select id="importMonth">
                    <option value="">Select month to import from</option>
                </select>
                <button class="import-btn" onclick="importIncome()">Import Income</button>
                <button class="import-btn" onclick="importBills()">Import Bills</button>
                <button class="import-btn" onclick="importFixedExpenses()">Import Fixed</button>
                <button class="import-btn" onclick="importSemiFixedExpenses()">Import Semi-Fixed</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'Plan')">üóìÔ∏è Plan</button>
            <button class="tab-link" onclick="openTab(event, 'Expenses')">üí∏ Expenses</button>
            <button class="tab-link" onclick="openTab(event, 'Extract')">üìä Budget Extract</button>
        </div>

        <div id="Plan" class="tab-content" style="display: block;">
            <div class="section">
                <h2 class="section-title">üí∞ Planned Income</h2>
                <table>
                    <thead>
                        <tr><th>Source</th><th style="width: 150px;">Amount</th><th style="width: 120px;">Received <input type="checkbox" onchange="toggleAll(this, 'plannedIncomeBody')"></th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="plannedIncomeBody"></tbody>
                    <tfoot>
                        <tr><td colspan="4"><button onclick="addPlannedIncomeRow()">+ Add Planned Income</button></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="section">
                 <div class="subsection-tabs">
                    <button class="sub-tab-link active" onclick="openSubTab(event, 'RegularBills')">üßæ Incoming Bills</button>
                    <button class="sub-tab-link" onclick="openSubTab(event, 'CreditCards')">üí≥ Credit Cards</button>
                </div>

                <div id="RegularBills" class="sub-tab-content" style="display: block;">
                    <h2 class="section-title">üßæ Incoming Bills</h2>
                    <table>
                        <thead>
                            <tr><th>Bill</th><th style="width: 130px;">Amount</th><th style="width: 150px;">Due Date</th><th style="width: 180px;">Category</th><th style="width: 100px;">Paid <input type="checkbox" onchange="toggleAll(this, 'plannedBillsBody')"></th><th style="width: 100px;">Action</th></tr>
                        </thead>
                        <tbody id="plannedBillsBody"></tbody>
                        <tfoot>
                            <tr><td colspan="6"><button onclick="addPlannedBillRow()">+ Add Bill</button></td></tr>
                        </tfoot>
                    </table>
                </div>

                <div id="CreditCards" class="sub-tab-content" style="display: none;">
                    <h2 class="section-title">üí≥ Credit Card Purchases</h2>
                    <div id="creditCardContainer"></div>
                    <button onclick="addCreditCardAccount()">+ Add Credit Card Account</button>
                </div>
            </div>
        </div>

        <div id="Expenses" class="tab-content">
             <div class="section">
                <h2 class="section-title">üí∞ Received Income</h2>
                <table id="incomeTable">
                    <thead>
                        <tr><th>Source</th><th style="width: 150px;">Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="incomeBody"></tbody>
                    <tfoot>
                        <tr class="total-row"><td>TOTAL RECEIVED</td><td id="totalIncome">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title">üîí Fixed Expenses</h2>
                <table>
                    <thead>
                        <tr><th>Expense</th><th style="width: 150px;">Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="fixedBody"></tbody>
                    <tfoot>
                         <tr><td colspan="3"><button onclick="addRow('fixedBody', 'fixed-amount')">+ Add Fixed Expense</button></td></tr>
                        <tr class="total-row"><td>TOTAL FIXED</td><td id="totalFixed">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title">üìä Semi-Fixed Expenses</h2>
                <table>
                    <thead>
                        <tr><th>Expense</th><th style="width: 150px;">Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="semiFixedBody"></tbody>
                    <tfoot>
                        <tr><td colspan="3"><button onclick="addRow('semiFixedBody', 'semifixed-amount')">+ Add Semi-Fixed Expense</button></td></tr>
                        <tr class="total-row"><td>TOTAL SEMI-FIXED</td><td id="totalSemiFixed">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title">‚ûï Extra Expenses</h2>
                <table>
                    <thead>
                        <tr><th>Expense</th><th style="width: 150px;">Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="extraBody"></tbody>
                    <tfoot>
                        <tr><td colspan="3"><button onclick="addRow('extraBody', 'extra-amount')">+ Add Extra Expense</button></td></tr>
                        <tr class="total-row"><td>TOTAL EXTRA</td><td id="totalExtra">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>
             <div class="section">
                <h2 class="section-title">üìÖ Long-Lasting Expenses (Loans)</h2>
                <table>
                    <thead>
                        <tr><th>Loan Name</th><th style="width: 130px;">Amount Left</th><th style="width: 130px;">Monthly Payment</th><th style="width: 110px;">Months Left</th><th style="width: 150px;">Increase Amount</th><th style="width: 100px;">Action</th></tr>
                    </thead>
                    <tbody id="loansBody"></tbody>
                    <tfoot>
                        <tr><td colspan="6"><button onclick="addLoanRow()">+ Add Loan</button></td></tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div id="Extract" class="tab-content">
            <div class="extract-section">
                <h2 class="section-title">üìà Budget Extract</h2>
                <div class="extract-grid" id="extractGrid"></div>
            </div>
    
            <div class="section">
                <h2 class="section-title">üí≥ Total Expenses</h2>
                <table>
                    <tbody>
                        <tr class="total-row"><td>TOTAL EXPENSES</td><td id="totalExpenses">$0.00</td><td></td></tr>
                    </tbody>
                </table>
            </div>
    
            <div class="balance-section">
                <h2>Final Balance</h2>
                <div class="balance-amount" id="finalBalance">$0.00</div>
            </div>
        </div>

    </div>
    
    <script type="module">
    // --- Firebase Configuration Injection ---
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBBldcELdbWroTVAoy5L1kw0_urUFfxMSc",
        authDomain: "finances-c7df4.firebaseapp.com",
        projectId: "finances-c7df4",
        storageBucket: "finances-c7df4.firebasestorage.app",
        messagingSenderId: "47587476297",
        appId: "1:47587476297:web:1077b1533e072b13801098",
        measurementId: "G-FEKN3WMBFS"
    };
    const APP_ID = FIREBASE_CONFIG.appId;
    const __firebase_config = JSON.stringify(FIREBASE_CONFIG);
    const __app_id = APP_ID;
    const SHARED_DOCUMENT_ID = "Budget_Global_Shared_Master"; 

    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global State and Firebase Variables ---
    let budgets = {};
    let currentMonth = '';
    let saveTimeout = null;
    let db;
    let userId;
    let isAuthReady = false;

    // --- Firebase Initialization ---
    async function initializeFirebase() {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        if (!firebaseConfig.apiKey) {
            document.body.innerHTML = '<h1>Error: Firebase configuration is missing.</h1>';
            return;
        }
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        userId = SHARED_DOCUMENT_ID;
        isAuthReady = true;
        await initApp();
    }

    // --- Application Initialization ---
    async function initApp() {
        if (!isAuthReady) return; 
        const now = new Date();
        currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('month').value = currentMonth;
        await loadBudgetsFromFirestore();
        loadCurrentMonthUI();
        attachListeners();
    }

    // --- Firebase Persistence ---
    async function loadBudgetsFromFirestore() {
        if (!userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/budgets/allData`);
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                budgets = docSnap.data() || {};
                console.log("Budgets loaded from Firestore.");
            } else {
                console.log("No existing budget document. Starting fresh.");
                budgets = {};
            }
        } catch (error) {
            console.error("Error loading budgets from Firestore:", error);
            budgets = {}; 
        }
        updateImportMonthOptions();
    }

    async function saveBudgetsToFirestore() {
        if (!userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/budgets/allData`);
        try {
            await setDoc(docRef, budgets);
            console.log("Budgets saved to Firestore.");
        } catch (error) {
            console.error("Error saving budgets to Firestore:", error);
        }
    }

    // --- Auto-Save Functionality ---
    function autoSave() {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveCurrentMonth();
            showSaveIndicator();
        }, 1000);
    }

    function showSaveIndicator() {
        const indicator = document.getElementById('saveIndicator');
        indicator.style.display = 'inline-block';
        setTimeout(() => { indicator.style.display = 'none'; }, 2000);
    }

    // --- Core Data Handling ---
    function saveCurrentMonth() {
        if (!budgets[currentMonth]) budgets[currentMonth] = {};

        const data = {
            plannedIncome: extractPlannedIncomeData(),
            plannedBills: extractPlannedBillsData(),
            creditCards: extractCreditCardData(),
            income: extractTableData('incomeBody'),
            fixed: extractTableData('fixedBody'),
            semFixed: extractTableData('semiFixedBody'),
            extra: extractTableData('extraBody'),
            loans: extractLoanData()
        };
        
        budgets[currentMonth] = data;

        const hasData = Object.values(data).some(arr => arr && arr.length > 0 && arr.some(item => Object.values(item).some(val => val)));
        if (!hasData) {
            delete budgets[currentMonth];
        }

        saveBudgetsToFirestore();
        updateImportMonthOptions();
    }
    
    function extractPlannedIncomeData() {
        return Array.from(document.querySelectorAll('#plannedIncomeBody tr')).map(row => ({
            description: row.querySelector('input[type="text"]').value,
            amount: parseFloat(row.querySelector('input[type="number"]').value) || 0,
            received: row.querySelector('input[type="checkbox"]').checked,
            id: row.dataset.id
        }));
    }
    
    function extractPlannedBillsData() {
        return Array.from(document.querySelectorAll('#plannedBillsBody tr')).filter(row => row.dataset.source !== 'credit-card').map(row => ({
            description: row.querySelector('input[type="text"]').value,
            amount: parseFloat(row.querySelector('.bill-amount').value) || 0,
            dueDate: row.querySelector('input[type="date"]').value,
            category: row.querySelector('select').value,
            paid: row.querySelector('input[type="checkbox"]').checked,
            id: row.dataset.id
        }));
    }
    
    function extractCreditCardData() {
        return Array.from(document.querySelectorAll('.credit-card-section')).map(cardSection => {
            const cardId = cardSection.dataset.cardId;
            return {
                id: cardId,
                name: cardSection.querySelector('.credit-card-name').value,
                billPaidThisMonth: cardSection.querySelector('.card-paid-checkbox').checked,
                purchases: Array.from(cardSection.querySelectorAll('.purchase-row')).map(row => {
                    const purchaseId = row.dataset.purchaseId;
                    const finishCheckbox = row.querySelector('.finish-payment-checkbox');
                    return {
                        id: purchaseId,
                        description: row.querySelector('.purchase-description').value,
                        totalAmount: parseFloat(row.querySelector('.purchase-total').value) || 0,
                        installmentsCurrent: parseInt(row.querySelector('.installments-current').value) || 0,
                        installmentsTotal: parseInt(row.querySelector('.installments-total').value) || 0,
                        finished: finishCheckbox ? finishCheckbox.checked : false
                    };
                })
            };
        });
    }

    function extractTableData(bodyId) {
        return Array.from(document.querySelectorAll(`#${bodyId} tr`))
            .filter(row => !row.dataset.sourceId) // Only manually added rows
            .map(row => ({
                description: row.querySelector('input[type="text"]').value,
                amount: parseFloat(row.querySelector('input[type="number"]').value) || 0
            }));
    }

    function extractLoanData() {
        return Array.from(document.querySelectorAll('#loansBody tr')).map(row => ({
            name: row.querySelector('input[type="text"]').value,
            amountLeft: parseFloat(row.querySelector('.loan-left').value) || 0,
            monthlyPayment: parseFloat(row.querySelector('.loan-monthly').value) || 0
        }));
    }

    // --- UI Population and Updates ---
    function loadCurrentMonthUI() {
        if (!budgets[currentMonth]) {
            carryOverData();
        }
        const data = budgets[currentMonth] || {};
        clearAllTables();
        
        loadPlannedIncome(data.plannedIncome || []);
        loadPlannedBills(data.plannedBills || []);
        loadCreditCardData(data.creditCards || []);
        
        loadTableData('incomeBody', 'income-amount', data.income || []);
        loadTableData('fixedBody', 'fixed-amount', data.fixed || []);
        loadTableData('semiFixedBody', 'semifixed-amount', data.semFixed || []);
        loadTableData('extraBody', 'extra-amount', data.extra || []);
        loadLoanData(data.loans || []);
        
        rebuildActualsFromPlan();
        updateCreditCardBillsInPlan();
        calculate();
    }

    function clearAllTables() {
        ['plannedIncomeBody', 'plannedBillsBody', 'creditCardContainer', 'incomeBody', 'fixedBody', 'semiFixedBody', 'extraBody', 'loansBody'].forEach(id => {
            document.getElementById(id).innerHTML = '';
        });
    }
    
    function loadPlannedIncome(data) {
        (data.length ? data : [{}]).forEach((item, index) => addPlannedIncomeRow(item, index));
    }

    function loadPlannedBills(data) {
        (data.length ? data : [{}]).forEach((item, index) => addPlannedBillRow(item, index));
    }
    
    function rebuildActualsFromPlan() {
        // Clear all derived rows first
        document.querySelectorAll('tr[data-source-id]').forEach(row => row.remove());

        const data = budgets[currentMonth] || {};
        (data.plannedIncome || []).forEach(item => {
            if (item.received) addActualRow('incomeBody', { description: item.description, amount: item.amount, sourceId: item.id });
        });
        (data.plannedBills || []).forEach(item => {
            if (item.paid) {
                const targetTable = { 'fixed': 'fixedBody', 'semifixed': 'semiFixedBody', 'extra': 'extraBody' }[item.category];
                if (targetTable) addActualRow(targetTable, { description: item.description, amount: item.amount, sourceId: item.id });
            }
        });
        rebuildCreditCardExpenses();
    }

    function rebuildCreditCardExpenses() {
        const cards = budgets[currentMonth]?.creditCards || [];
        cards.forEach(card => {
            const existingRow = document.querySelector(`#semiFixedBody tr[data-source-id="cc-bill-${card.id}"]`);
            if (card.billPaidThisMonth) {
                const totalBill = card.purchases.reduce((sum, p) => sum + ((p.totalAmount || 0) / (p.installmentsTotal || 1)), 0);
                if (totalBill > 0) {
                    if (!existingRow) {
                        addActualRow('semiFixedBody', {
                            description: `${card.name} Bill`,
                            amount: totalBill.toFixed(2),
                            sourceId: `cc-bill-${card.id}`
                        });
                    }
                } else {
                     if(existingRow) existingRow.remove();
                }
            } else {
                if (existingRow) existingRow.remove();
            }
        });
    }

    function loadTableData(bodyId, className, data) {
        (data && data.length > 0 ? data : []).forEach(item => addRow(bodyId, className, item));
    }
    
    function loadLoanData(data) {
        (data && data.length > 0 ? data : [{}]).forEach(loan => addLoanRow(loan));
    }

    // --- Global Functions for UI Interaction ---
    window.openTab = function(evt, tabName) {
        document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
        document.querySelectorAll(".tab-link").forEach(tl => tl.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }
    
    window.openSubTab = function(evt, tabName) {
        const parent = evt.target.closest('.section');
        parent.querySelectorAll('.sub-tab-content').forEach(content => content.style.display = 'none');
        parent.querySelectorAll('.sub-tab-link').forEach(link => link.classList.remove('active'));
        parent.querySelector('#' + tabName).style.display = 'block';
        evt.currentTarget.classList.add('active');
    }

    window.toggleAll = function(sourceCheckbox, bodyId) {
        document.querySelectorAll(`#${bodyId} input[type="checkbox"]`).forEach(checkbox => {
            if (checkbox.checked !== sourceCheckbox.checked && !checkbox.disabled) {
                checkbox.checked = sourceCheckbox.checked;
                checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    }

    window.addRow = function(bodyId, className, item = {}) {
        const row = document.getElementById(bodyId).insertRow();
        row.innerHTML = `
            <td><input type="text" placeholder="Description" value="${item.description || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="${className}" value="${item.amount || ''}"></td>
            <td><button class="delete" onclick="deleteRow(this)">Delete</button></td>
        `;
    }
    
    window.addPlannedIncomeRow = function(item = {}, index = 0) {
        const row = document.getElementById('plannedIncomeBody').insertRow();
        row.dataset.id = item.id || `income-${Date.now()}-${index}`;
        row.innerHTML = `
            <td><input type="text" placeholder="Source" value="${item.description || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" value="${item.amount || ''}"></td>
            <td><input type="checkbox" onchange="handleIncomeReceived(this)" ${item.received ? 'checked' : ''}></td>
            <td><button class="delete" onclick="deletePlannedRow(this, 'income')">Delete</button></td>
        `;
        if (item.received) row.classList.add('paid');
    }

    window.addPlannedBillRow = function(item = {}, index = 0, isReadOnly = false) {
        const row = document.getElementById('plannedBillsBody').insertRow();
        row.dataset.id = item.id || `bill-${Date.now()}-${index}`;
        if (item.source) {
            row.dataset.source = item.source;
            row.dataset.cardId = item.cardId;
        }
        const isCreditCardBill = item.source === 'credit-card';
        row.innerHTML = `
            <td><input type="text" placeholder="Bill Name" value="${item.description || ''}" ${isReadOnly ? 'readonly' : ''}></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="bill-amount" value="${item.amount || ''}" ${isReadOnly ? 'readonly' : ''}></td>
            <td><input type="date" value="${item.dueDate || ''}" ${isReadOnly ? 'readonly' : ''}></td>
            <td>
                <select ${isReadOnly ? 'disabled' : ''}>
                    <option value="fixed" ${item.category === 'fixed' ? 'selected' : ''}>Fixed</option>
                    <option value="semifixed" ${item.category === 'semifixed' ? 'selected' : ''}>Semi-Fixed</option>
                    <option value="extra" ${item.category === 'extra' ? 'selected' : ''}>Extra</option>
                </select>
            </td>
            <td><input type="checkbox" onchange="handlePayment(this)" ${item.paid ? 'checked' : ''} ${isCreditCardBill ? 'disabled' : ''}></td>
            <td><button class="delete" onclick="deletePlannedRow(this, 'bill')" ${isReadOnly ? 'style="display:none;"' : ''}>Delete</button></td>
        `;
        if (item.paid) row.classList.add('paid');
    }
    
    function addActualRow(bodyId, item) {
        const tbody = document.getElementById(bodyId);
        const row = tbody.insertRow();
        row.dataset.sourceId = item.sourceId; 
        row.innerHTML = `
            <td><input type="text" value="${item.description || ''}" readonly></td>
            <td><input type="number" step="0.01" value="${item.amount || ''}" readonly></td>
            <td></td>
        `;
    }

    window.addLoanRow = function(loan = {}) {
        const row = document.getElementById('loansBody').insertRow();
        const monthsLeft = (loan.monthlyPayment > 0 && loan.amountLeft) ? Math.ceil(loan.amountLeft / loan.monthlyPayment) : 0;
        row.innerHTML = `
            <td><input type="text" placeholder="Loan Name" value="${loan.name || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="loan-left" value="${loan.amountLeft || ''}"></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="loan-monthly" value="${loan.monthlyPayment || ''}"></td>
            <td><input type="number" placeholder="0" class="loan-months" readonly value="${monthsLeft}"></td>
            <td><div class="loan-increase-controls"><input type="number" step="0.01" placeholder="0.00" class="loan-increase-input"><button class="increase-btn" onclick="increaseLoan(this)">+</button></div></td>
            <td><button class="delete" onclick="deleteRow(this)">Delete</button></td>
        `;
    }
    
    window.handleIncomeReceived = function(checkbox) {
        const row = checkbox.closest('tr');
        row.classList.toggle('paid', checkbox.checked);
        rebuildActualsFromPlan();
        calculate();
        autoSave();
    }

    window.handlePayment = function(checkbox) {
        const row = checkbox.closest('tr');
        row.classList.toggle('paid', checkbox.checked);
        rebuildActualsFromPlan();
        calculate();
        autoSave();
    }
    
    window.deleteRow = function(btn) {
        btn.closest('tr').remove();
        calculate();
        autoSave();
    }
    
    window.deletePlannedRow = function(btn, type) {
        const row = btn.closest('tr');
        row.remove();
        rebuildActualsFromPlan();
        calculate();
        autoSave();
    }

    function calculate() {
        const totalIncome = Array.from(document.querySelectorAll('#incomeBody input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
        const totalFixed = Array.from(document.querySelectorAll('#fixedBody input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
        const totalSemiFixed = Array.from(document.querySelectorAll('#semiFixedBody input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
        const totalExtra = Array.from(document.querySelectorAll('#extraBody input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);

        document.getElementById('totalIncome').textContent = '$' + totalIncome.toFixed(2);
        document.getElementById('totalFixed').textContent = '$' + totalFixed.toFixed(2);
        document.getElementById('totalSemiFixed').textContent = '$' + totalSemiFixed.toFixed(2);
        document.getElementById('totalExtra').textContent = '$' + totalExtra.toFixed(2);
        
        const totalExpenses = totalFixed + totalSemiFixed + totalExtra;
        const balance = totalIncome - totalExpenses;
        const balanceEl = document.getElementById('finalBalance');
        
        document.getElementById('totalExpenses').textContent = '$' + totalExpenses.toFixed(2);
        balanceEl.textContent = '$' + balance.toFixed(2);
        balanceEl.className = 'balance-amount';
        balanceEl.classList.add(balance >= 0 ? 'positive' : 'negative');

        updateExtract();
    }
    
    // --- Credit Card Specific Functions ---
    function carryOverData() {
        const [year, month] = currentMonth.split('-').map(Number);
        const prevDate = new Date(year, month - 2, 15);
        const prevMonth = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;
        const prevMonthData = budgets[prevMonth];
        if (!prevMonthData) return;

        const newCards = (prevMonthData.creditCards || []).map(card => ({
            id: card.id,
            name: card.name,
            billPaidThisMonth: false,
            purchases: (card.purchases || [])
                .filter(p => !p.finished)
                .map(p => ({
                    ...p,
                    installmentsCurrent: p.installmentsCurrent + 1,
                })).filter(p => p.installmentsCurrent <= p.installmentsTotal)
        }));

        if (!budgets[currentMonth]) budgets[currentMonth] = {};
        budgets[currentMonth].creditCards = newCards;
    }

    function loadCreditCardData(cards = []) {
        document.getElementById('creditCardContainer').innerHTML = '';
        cards.forEach(card => addCreditCardAccount(card));
    }

    window.addCreditCardAccount = function(cardData = {}) {
        const cardId = cardData.id || `cc-${Date.now()}`;
        const container = document.getElementById('creditCardContainer');
        
        const section = document.createElement('div');
        section.className = 'credit-card-section';
        section.dataset.cardId = cardId;
        
        const totalBill = (cardData.purchases || []).reduce((sum, p) => sum + ((p.totalAmount || 0) / (p.installmentsTotal || 1)), 0);

        section.innerHTML = `
            <div class="credit-card-header">
                <input type="text" class="credit-card-name" placeholder="Credit Card Name" value="${cardData.name || ''}">
                <div class="credit-card-header-controls">
                     <div class="credit-card-total-display">
                        <label>Monthly Bill:</label>
                        <input type="text" class="credit-card-total-input" value="$${totalBill.toFixed(2)}" readonly>
                    </div>
                    <div class="card-paid-control">
                        <label>Paid</label>
                        <input type="checkbox" class="card-paid-checkbox" onchange="handleCardBillPaid(this, '${cardId}')" ${cardData.billPaidThisMonth ? 'checked' : ''}>
                    </div>
                    <button class="delete" onclick="deleteCreditCard(this)">Delete Card</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th style="width: 130px;">Total Amount</th>
                        <th style="width: 150px;">Installments</th>
                        <th style="width: 130px;">Monthly Pay</th>
                        <th style="width: 180px;">Finished Paying</th>
                        <th style="width: 100px;">Action</th>
                    </tr>
                </thead>
                <tbody class="credit-card-purchases-body"></tbody>
            </table>
            <button onclick="addCreditCardPurchase('${cardId}')">+ Add Purchase</button>
        `;
        container.appendChild(section);

        const purchasesBody = section.querySelector('.credit-card-purchases-body');
        (cardData.purchases || []).forEach(p => addCreditCardPurchaseRow(purchasesBody, p));
    }
    
    function addCreditCardPurchaseRow(tbody, purchaseData = {}) {
        const purchaseId = purchaseData.id || `pur-${Date.now()}`;
        const row = tbody.insertRow();
        row.className = 'purchase-row';
        row.dataset.purchaseId = purchaseId;

        const total = purchaseData.totalAmount || 0;
        const current = purchaseData.installmentsCurrent || 0;
        const totalInstallments = purchaseData.installmentsTotal || 0;
        const monthly = totalInstallments > 0 ? (total / totalInstallments).toFixed(2) : '0.00';

        let finishedHtml = '<td>N/A</td>';
        if (current > 0 && current === totalInstallments) {
            finishedHtml = `
                <td>
                    <div class="finish-payment-control">
                        <label>Mark as Finished</label>
                        <input type="checkbox" class="finish-payment-checkbox" ${purchaseData.finished ? 'checked' : ''}>
                    </div>
                </td>`;
        }
        
        row.innerHTML = `
            <td><input type="text" class="purchase-description" placeholder="e.g., New Laptop" value="${purchaseData.description || ''}"></td>
            <td><input type="number" step="0.01" class="purchase-total" placeholder="1200.00" value="${total || ''}"></td>
            <td>
                <div class="installments-input">
                    <input type="number" class="installments-current" placeholder="1" value="${current || ''}">
                    <span>/</span>
                    <input type="number" class="installments-total" placeholder="12" value="${totalInstallments || ''}">
                </div>
            </td>
            <td><input type="number" class="purchase-monthly" value="${monthly}" readonly></td>
            ${finishedHtml}
            <td><button class="delete" onclick="deleteCreditCardPurchase(this)">Delete</button></td>
        `;
    }
    
    window.addCreditCardPurchase = function(cardId) {
        const cardSection = document.querySelector(`.credit-card-section[data-card-id="${cardId}"]`);
        if(cardSection){
            addCreditCardPurchaseRow(cardSection.querySelector('.credit-card-purchases-body'));
        }
    }

    window.deleteCreditCard = function(btn) {
        const cardSection = btn.closest('.credit-card-section');
        cardSection.remove();
        autoSave();
        loadCurrentMonthUI(); // Force a full reload to ensure dependent data is cleared
    }

    window.deleteCreditCardPurchase = function(btn) {
        const row = btn.closest('tr');
        const cardSection = row.closest('.credit-card-section');
        row.remove();
        updateCardOnInputChange(cardSection); // Update totals
    }

    window.handleCardBillPaid = function(checkbox, cardId) {
        const card = budgets[currentMonth].creditCards.find(c => c.id === cardId);
        if (card) card.billPaidThisMonth = checkbox.checked;

        const billRowCheckbox = document.querySelector(`#plannedBillsBody tr[data-card-id="${cardId}"] input[type="checkbox"]`);
        if (billRowCheckbox) {
            billRowCheckbox.checked = checkbox.checked;
            billRowCheckbox.closest('tr').classList.toggle('paid', checkbox.checked);
        }
        rebuildCreditCardExpenses();
        calculate();
        autoSave();
    }
    
    function updateCreditCardBillsInPlan() {
        document.querySelectorAll('#plannedBillsBody tr[data-source="credit-card"]').forEach(row => row.remove());
        const cards = budgets[currentMonth]?.creditCards || [];
        cards.forEach(card => {
            const totalBill = card.purchases.reduce((sum, p) => sum + ((p.totalAmount || 0) / (p.installmentsTotal || 1)), 0);
            if (totalBill > 0) {
                addPlannedBillRow({
                    cardId: card.id,
                    description: `${card.name} Bill`,
                    amount: totalBill.toFixed(2),
                    category: 'semifixed',
                    paid: card.billPaidThisMonth || false,
                    source: 'credit-card'
                }, 0, true);
            }
        });
    }

    function updateCardOnInputChange(cardSection) {
        const purchases = Array.from(cardSection.querySelectorAll('.purchase-row'));
        const totalBill = purchases.reduce((sum, row) => {
            const total = parseFloat(row.querySelector('.purchase-total').value) || 0;
            const installments = parseInt(row.querySelector('.installments-total').value) || 1;
            return sum + (total / installments);
        }, 0);
        cardSection.querySelector('.credit-card-total-input').value = `$${totalBill.toFixed(2)}`;
        autoSave();
    }


    // --- Import/Export and Listeners ---
    function updateImportMonthOptions() {
        const select = document.getElementById('importMonth');
        select.innerHTML = '<option value="">Select month to import from</option>';
        Object.keys(budgets).sort().reverse().forEach(month => {
            if (month !== currentMonth) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                select.appendChild(option);
            }
        });
    }
    
    function importData(dataType) {
        const selectedMonth = document.getElementById('importMonth').value;
        if (!selectedMonth || !budgets[selectedMonth]) return;
        if (!budgets[currentMonth]) budgets[currentMonth] = {};
        budgets[currentMonth][dataType] = JSON.parse(JSON.stringify(budgets[selectedMonth][dataType] || []));
        loadCurrentMonthUI();
        autoSave();
    }
    window.importIncome = () => importData('plannedIncome');
    window.importBills = () => importData('plannedBills');
    window.importFixedExpenses = () => importData('fixed');
    window.importSemiFixedExpenses = () => importData('semFixed');
    
    window.increaseLoan = function(btn) {
        const row = btn.closest('tr');
        const increaseInput = row.querySelector('.loan-increase-input');
        const leftInput = row.querySelector('.loan-left');
        leftInput.value = ((parseFloat(leftInput.value) || 0) + (parseFloat(increaseInput.value) || 0)).toFixed(2);
        increaseInput.value = '';
        autoSave();
    }

    function updateExtract() {
        const grid = document.getElementById('extractGrid');
        grid.innerHTML = '';
        const data = {
            'Total Received Income': { amount: document.getElementById('totalIncome').textContent, color: '#2ecc71' },
            'Fixed Expenses': { amount: document.getElementById('totalFixed').textContent, color: '#e74c3c' },
            'Semi-Fixed Expenses': { amount: document.getElementById('totalSemiFixed').textContent, color: '#e67e22' },
            'Total Extra Expenses': { amount: document.getElementById('totalExtra').textContent, color: '#f39c12' },
            'Total Expenses': { amount: document.getElementById('totalExpenses').textContent, color: '#c0392b' },
            'Final Balance': { amount: document.getElementById('finalBalance').textContent, color: document.getElementById('finalBalance').textContent.includes('-') ? '#e74c3c' : '#27ae60' }
        };
        for (const [title, { amount, color }] of Object.entries(data)) {
            const item = document.createElement('div');
            item.className = 'extract-item';
            item.style.borderLeftColor = color;
            item.innerHTML = `<h4>${title}</h4><div class="amount">${amount}</div>`;
            grid.appendChild(item);
        }
    }

    function attachListeners() {
        document.querySelector('.container').addEventListener('input', (e) => {
            if (e.target.matches('input, select') && !e.target.matches('[type="checkbox"]')) {
                const cardSection = e.target.closest('.credit-card-section');
                if (cardSection) {
                    updateCardOnInputChange(cardSection);
                } else {
                    autoSave();
                }
                 // Always calculate on any input
                rebuildActualsFromPlan();
                calculate();
            }
        });

         document.querySelector('.container').addEventListener('change', (e) => {
             if (e.target.matches('input[type="checkbox"]')) {
                 autoSave();
                 rebuildActualsFromPlan();
                 calculate();
             }
         });


        document.getElementById('month').addEventListener('change', (e) => {
            saveCurrentMonth(); 
            currentMonth = e.target.value;
            loadCurrentMonthUI();
        });
    }
    
    // --- App Start ---
    document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>

